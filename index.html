<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Glukose Diagramm – Monatsansicht</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        padding: 20px;
        color: #222;
    }

    textarea {
        width: 100%;
        height: 200px;
        font-size: 14px;
        margin-bottom: 15px;
    }

    button {
        width: 100%;
        padding: 14px;
        font-size: 18px;
        background: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        margin-bottom: 25px;
    }

    button:hover {
        background: #45a049;
    }

    .page {
        background: white;
        border: 1px solid #ccc;
        padding: 20px;
        margin-bottom: 60px;
        page-break-after: always;
    }

    .month-title {
        font-size: 30px;
        margin-bottom: 10px;
    }

    .legend {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding: 10px;
        background: #fff;
        border: 1px solid #ccc;
        font-size: 14px;
    }

    .legend div {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .box { width: 14px; height: 14px; }

    .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
    }

    .daycell {
        border: 1px solid #ddd;
        height: 220px;
        padding: 4px;
        position: relative;
        background: #fafafa;
    }

    .daynum {
        position: absolute;
        top: 4px;
        right: 6px;
        font-size: 13px;
        font-weight: bold;
    }

    .avgbox {
        margin-top: 15px;
        padding: 8px;
        border: 1px solid #ccc;
        background: #fff;
    }

</style>
</head>
<body>

<h1>Glukose Monatsgenerator</h1>

<textarea id="input"></textarea>
<button onclick="generate()">Diagramme erzeugen</button>

<div id="output"></div>

<script>
/* Farben pro Messart */
const COLORS = {
  "Frühstück": "#00aaff",
  "Mittagessen": "#00cc44",
  "Abendessen": "#ff9900",
  "Schlafen": "#ff3333",
  "Zwischenmessung": "#aa55ff"
};

/* Parsing */
function parseData(text) {
  const lines = text.split("\n").map(l => l.trim());
  const out = [];
  let curDate = null;

  for (let line of lines) {
    if (line.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
      curDate = line;
      continue;
    }

    const m = line.match(/(Frühstück|Mittagessen|Abendessen|Schlafen|Zwischenmessung).*?(\d+)\s*$/);
    if (m && curDate) {
      out.push({
        date: curDate,
        type: m[1],
        value: parseInt(m[2]),
        color: COLORS[m[1]]
      });
    }
  }

  return out;
}

/* Date helpers */
function toISO(d) {
  const [day,month,year] = d.split(".");
  return new Date(year, month-1, day);
}

/* Gruppieren nach Monat */
function groupByMonth(entries) {
  const map = {};
  for (let e of entries) {
    const d = toISO(e.date);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    if (!map[key]) map[key] = [];
    map[key].push(e);
  }
  return map;
}

/* Durchschnitt */
function avg(arr) {
  if (!arr.length) return 0;
  return Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
}

/* Zeichnet Balken in ein Tagesfeld */
function drawBars(cell, dayEntries) {
  const canvas = document.createElement("canvas");
  canvas.width = 180;
  canvas.height = 160;
  canvas.style.width = "100%";
  const ctx = canvas.getContext("2d");

  const maxVal = Math.max(160, ...dayEntries.map(e=>e.value));
  const barWidth = 18;
  const gap = 6;
  let x = 10;
  const baseY = 150;

  for (let e of dayEntries) {
    let h = (e.value / maxVal) * 120;
    ctx.fillStyle = e.color;
    ctx.fillRect(x, baseY - h, barWidth, h);

    ctx.strokeStyle = "white";
    ctx.lineWidth = 1;
    ctx.strokeRect(x, baseY - h, barWidth, h);

    ctx.fillStyle = "black";
    ctx.font = "12px Arial";
    ctx.fillText(e.value, x, baseY - h - 5);

    x += barWidth + gap;
  }

  cell.appendChild(canvas);
}

/* Hauptgenerator */
function generate() {
  const text = document.getElementById("input").value.trim();
  const out = document.getElementById("output");
  out.innerHTML = "";
  if (!text) return;

  const entries = parseData(text)
    .sort((a,b)=>toISO(a.date)-toISO(b.date));

  const months = groupByMonth(entries);

  /* Legende */
  const legend = document.createElement("div");
  legend.className = "legend";
  legend.innerHTML = `
    <div><div class="box" style="background:#00aaff"></div> Frühstück</div>
    <div><div class="box" style="background:#00cc44"></div> Mittagessen</div>
    <div><div class="box" style="background:#ff9900"></div> Abendessen</div>
    <div><div class="box" style="background:#ff3333"></div> Schlafen</div>
    <div><div class="box" style="background:#aa55ff"></div> Zwischenmessung</div>
  `;
  out.appendChild(legend);

  for (let monthKey in months) {
    const monthEntries = months[monthKey];
    const page = document.createElement("div");
    page.className = "page";

    /* Titel */
    const mdate = toISO(monthEntries[0].date);
    const monthName = mdate.toLocaleString("de-DE",{month:"long"});
    const title = document.createElement("div");
    title.className = "month-title";
    title.textContent = `${monthName} ${mdate.getFullYear()}`;
    page.appendChild(title);

    /* Kalendergitter */
    const grid = document.createElement("div");
    grid.className = "calendar";

    /* Tagesfelder generieren */
    const firstDay = new Date(mdate.getFullYear(), mdate.getMonth(), 1);
    const lastDay = new Date(mdate.getFullYear(), mdate.getMonth()+1, 0);
    const startOffset = (firstDay.getDay()+6)%7;  // Mo=0

    /* Leere Felder vor dem Monat */
    for (let i=0;i<startOffset;i++){
      const empty = document.createElement("div");
      empty.className = "daycell";
      grid.appendChild(empty);
    }

    /* Jeder Tag des Monats */
    for (let d=1; d <= lastDay.getDate(); d++) {
      const cell = document.createElement("div");
      cell.className = "daycell";

      const label = document.createElement("div");
      label.className = "daynum";
      label.textContent = d;
      cell.appendChild(label);

      const dateStr = `${d}.${mdate.getMonth()+1}.${mdate.getFullYear()}`;

      const dayEntries = monthEntries.filter(e=>e.date===dateStr);

      if (dayEntries.length > 0) {
        drawBars(cell, dayEntries);
      }

      grid.appendChild(cell);
    }

    page.appendChild(grid);

    /* Durchschnittswerte */
    const vals = monthEntries.map(e=>e.value);

    const avgBox = document.createElement("div");
    avgBox.className = "avgbox";
    avgBox.innerHTML = `<b>Monatsdurchschnitt:</b> ${avg(vals)} mg/dl`;
    page.appendChild(avgBox);

    out.appendChild(page);
  }
}
</script>

</body>
</html>
