<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Glukose Diagramm mit Durchschnitten</title>
<script src="cdn.jsdelivr.net"></script>
<style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    h1 { text-align: center; }
    textarea { width: 100%; height: 200px; padding: 10px; box-sizing: border-box; }
    button { padding: 12px; margin-top: 10px; background: #4CAF50; border: none; color: white; cursor: pointer; width: 100%; }
    button:hover { background: #45A049; }
    .page { page-break-inside: avoid; margin-bottom: 30px; padding: 15px; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .chart-container { position: relative; height: 400px; width: 100%; margin-top: 10px; }
</style>
</head>
<body>

<h1>Glukose Diagramm Generator</h1>

<textarea id="input" placeholder="Fügen Sie hier Ihre Daten ein..."></textarea>
<button onclick="generateCharts()">Diagramme erzeugen</button>

<div id="output"></div>

<script>
    // Beispiel Daten zum Testen
    document.getElementById("input").value = `
01.12.2025
Frühstück: 110
Mittagessen: 145
Abendessen: 130
Schlafen: 120

02.12.2025
Frühstück: 105
Mittagessen: 155
Abendessen: 140
Schlafen: 115

03.12.2025
Frühstück: 98
Mittagessen: 135
Abendessen: 125
Schlafen: 100

04.12.2025
Frühstück: 120
Mittagessen: 160
Abendessen: 135
Schlafen: 110

05.12.2025
Frühstück: 115
Mittagessen: 142
Abendessen: 128
Schlafen: 105

08.12.2025
Frühstück: 110
Mittagessen: 145
Abendessen: 130
Schlafen: 120
`;


    function parseData(text) {
        const lines = text.split("\n").map(l => l.trim()).filter(l => l.length > 0);
        const entries = [];
        let currentDate = null;

        for (let line of lines) {
            if (line.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
                currentDate = line;
                continue;
            }

            const m = line.match(/(Frühstück|Mittagessen|Abendessen|Schlafen|Zwischenmessung):\s*(\d+)\s*$/);
            if (m && currentDate) {
                entries.push({
                    date: currentDate,
                    type: m[1],
                    value: parseInt(m[2]),
                });
            }
        }
        return entries;
    }

    function dateToISO(d) {
        const [day, month, year] = d.split(".");
        return new Date(year, month - 1, day);
    }

    function getWeekNumber(date) {
        const d = new Date(date.getTime());
        d.setHours(0,0,0,0);
        d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
        const week1 = new Date(d.getFullYear(), 0, 4);
        return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
    }

    function groupByWeek(entries) {
        const map = {};
        for (let e of entries) {
            const iso = dateToISO(e.date);
            const year = iso.getFullYear();
            const week = getWeekNumber(iso);
            const key = `${year}-KW${week}`;
            if (!map[key]) map[key] = [];
            map[key].push(e);
        }
        return map;
    }

    function calculateAverages(weekData) {
        const uniqueDays = [...new Set(weekData.map(e => e.date))];
        const dayAverages = {};
        let weekTotal = 0;
        let weekCount = 0;

        for (const day of uniqueDays) {
            const dayEntries = weekData.filter(e => e.date === day);
            const dayTotal = dayEntries.reduce((sum, e) => sum + e.value, 0);
            dayAverages[day] = dayTotal / dayEntries.length;
            weekTotal += dayTotal;
            weekCount += dayEntries.length;
        }

        const weekAverage = weekTotal / weekCount;
        return { dayAverages, weekAverage };
    }


    function generateCharts() {
        const text = document.getElementById("input").value;
        const output = document.getElementById("output");
        output.innerHTML = "";
        
        const entries = parseData(text);
        if (entries.length === 0) {
            output.innerHTML = "<p>Keine gültigen Daten gefunden.</p>";
            return;
        }
        
        const weeks = groupByWeek(entries);
        const sortedWeeksKeys = Object.keys(weeks).sort();
        
        const typeColors = {
            "Frühstück": "rgba(0, 170, 255, 0.8)",
            "Mittagessen": "rgba(0, 204, 68, 0.8)",
            "Abendessen": "rgba(255, 153, 0, 0.8)",
            "Schlafen": "rgba(255, 51, 51, 0.8)",
            "Zwischenmessung": "rgba(170, 85, 255, 0.8)"
        };


        for (const weekKey of sortedWeeksKeys) {
            const data = weeks[weekKey];
            const { dayAverages, weekAverage } = calculateAverages(data);

            // Daten für Chart.js vorbereiten
            const chartData = {
                labels: [], // TT.MM.JJJJ
                datasets: [
                    {
                        label: 'Werte',
                        data: [], // Enthält {x: datum, y: wert, type: typ}
                        backgroundColor: [],
                        type: 'bar',
                        barPercentage: 0.8,
                        categoryPercentage: 0.8,
                    },
                    {
                        label: 'Tagesdurchschnitt',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: false,
                        type: 'line',
                        pointRadius: 0,
                    },
                    {
                        label: `Wochendurchschnitt (${weekAverage.toFixed(0)})`,
                        data: Array(data.length).fill(weekAverage),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        fill: false,
                        type: 'line',
                        pointRadius: 0,
                    }
                ]
            };

            // Sortieren nach Datum für korrekte X-Achse Reihenfolge
            data.sort((a, b) => dateToISO(a.date) - dateToISO(b.date));

            data.forEach(entry => {
                chartData.labels.push(entry.date + ' (' + entry.type + ')'); // Label mit Datum und Typ
                chartData.datasets[0].data.push(entry.value);
                chartData.datasets[0].backgroundColor.push(typeColors[entry.type]);
                chartData.datasets[1].data.push(dayAverages[entry.date]);
            });


            // --- DOM Erstellung ---
            const page = document.createElement("div");
            page.className = "page";
            const header = document.createElement("h2");
            header.textContent = `Woche: ${weekKey}`;
            page.appendChild(header);

            const container = document.createElement("div");
            container.className = "chart-container";
            const canvas = document.createElement("canvas");
            container.appendChild(canvas);
            page.appendChild(container);
            output.appendChild(page);

            // --- Chart.js Initialisierung ---
            new Chart(canvas, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 40,
                            max: 180, // Habe das Maximum etwas erhöht für bessere Skalierung
                            title: {
                                display: true,
                                text: 'Glukosewert (mg/dL)'
                            }
                        },
                        x: {
                            // Achsenbeschriftung ist das Datum + Typ
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: `Blutzuckerwerte ${weekKey}`
                        }
                    }
                }
            });
        }
    }
</script>
</body>
</html>
