<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Blutzucker Diagramme</title>

<style>
    body {
        background: #222;
        color: #fff;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
    }

    h1, h2, h3, .legend {
        -webkit-text-stroke: 0.5px white; /* d√ºnnere wei√üe Kontur */
    }

    .month-page {
        page-break-after: always;
        padding-bottom: 40px;
    }

    .week-block {
        margin-bottom: 40px;
        padding: 15px;
        border: 1px solid #666;
        border-radius: 8px;
    }

    .week-title {
        font-size: 20px;
        margin-bottom: 10px;
        -webkit-text-stroke: 0.4px white;
    }

    .chart-container {
        height: 280px; /* h√∂heres Diagramm */
        margin-bottom: 30px;
    }

    .legend {
        font-size: 16px;
        margin-bottom: 10px;
    }

    .download-btn {
        background: #4caf50;
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        display: inline-block;
        cursor: pointer;
        margin: 10px 0;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>

<h1>Blutzucker Diagramm ‚Äì Automatische Monatsansicht</h1>
<div class="download-btn" onclick="exportPDF()">üìÑ PDF Exportieren</div>

<div id="content"></div>

<script>
/* -----------------------------
   BENUTZERDATEN HIER EINF√úGEN
   ----------------------------- */
const rawText = `
20.10.2025 Fr√ºhst√ºck 117
20.10.2025 Mittagessen 139
20.10.2025 Abendessen 93
20.10.2025 Schlafen 122

21.10.2025 Fr√ºhst√ºck 109
21.10.2025 Mittagessen 109
21.10.2025 Abendessen 106
21.10.2025 Schlafen 116

22.10.2025 Fr√ºhst√ºck 118
22.10.2025 Mittagessen 94
22.10.2025 Abendessen 115
22.10.2025 Schlafen 100

23.10.2025 Fr√ºhst√ºck 114
23.10.2025 Mittagessen 97
23.10.2025 Abendessen 118
23.10.2025 Schlafen 130

24.10.2025 Fr√ºhst√ºck 115
24.10.2025 Zwischen 167
24.10.2025 Zwischen 103
24.10.2025 Mittagessen 124
24.10.2025 Abendessen 92
24.10.2025 Schlafen 183

25.10.2025 Fr√ºhst√ºck 97
25.10.2025 Mittagessen 86
25.10.2025 Abendessen 158
25.10.2025 Schlafen 145

26.10.2025 Fr√ºhst√ºck 102
26.10.2025 Mittagessen 94
26.10.2025 Abendessen 124
26.10.2025 Schlafen 160

27.10.2025 Fr√ºhst√ºck 136
27.10.2025 Mittagessen 84
27.10.2025 Abendessen 104
27.10.2025 Schlafen 97

28.10.2025 Fr√ºhst√ºck 113
28.10.2025 Mittagessen 84
28.10.2025 Abendessen 114
28.10.2025 Schlafen 115

29.10.2025 Fr√ºhst√ºck 109
29.10.2025 Mittagessen 100
29.10.2025 Abendessen 113
29.10.2025 Schlafen 87
`;

/* ------------------------------------------------------------
   PARSER ‚Äì extrahiert Datum ‚Üí Werte (Fr√ºh, Mittag, Abend, Schlaf)
------------------------------------------------------------ */

function parseData(text) {
    const lines = text.trim().split("\n");
    const data = {};

    for (let ln of lines) {
        ln = ln.trim();
        if (!ln) continue;

        const parts = ln.split(" ");
        const date = parts[0];

        if (!data[date]) data[date] = { Fr√ºh: null, Mittag: null, Abend: null, Schlaf: null, Zwischen: [] };

        const type = parts[1].toLowerCase();
        const value = parseInt(parts[2]);

        if (type.startsWith("fr√ºh")) data[date].Fr√ºh = value;
        else if (type.startsWith("mittag")) data[date].Mittag = value;
        else if (type.startsWith("abend")) data[date].Abend = value;
        else if (type.startsWith("schlaf")) data[date].Schlaf = value;
        else if (type.startsWith("zwischen")) data[date].Zwischen.push(value);
    }

    return data;
}

/* ---------------------------------------------------------
   MONATS & WOCHEN LOGIK
--------------------------------------------------------- */

function groupByMonth(data) {
    const months = {};

    for (const date in data) {
        const [d, m, y] = date.split(".");
        const key = `${m}.${y}`; 

        if (!months[key]) months[key] = {};
        months[key][date] = data[date];
    }

    return months;
}

function weekOfMonth(date) {
    const [day, month, year] = date.split(".").map(Number);
    const dt = new Date(year, month - 1, day);
    const week = Math.ceil((dt.getDate() + 6 - dt.getDay()) / 7);
    return week;
}

/* ---------------------------------------------------------
   DIAGRAMM GENERIERUNG
--------------------------------------------------------- */

function makeChart(ctx, dayData, wAvg, mAvg) {
    return new Chart(ctx, {
        type: "bar",
        data: {
            labels: ["Fr√ºh", "Mittag", "Abend", "Schlaf"],
            datasets: [
                {
                    label: "Werte",
                    data: [dayData.Fr√ºh, dayData.Mittag, dayData.Abend, dayData.Schlaf],
                    backgroundColor: "rgba(100,150,255,0.7)",
                    borderColor: "white",
                    borderWidth: 1,
                    barThickness: 25
                },
                {
                    label: "Tagesschnitt",
                    data: [dayData.avg, dayData.avg, dayData.avg, dayData.avg],
                    type: "line",
                    borderColor: "yellow",
                    borderWidth: 2
                },
                {
                    label: "Wochenschnitt",
                    data: [wAvg, wAvg, wAvg, wAvg],
                    type: "line",
                    borderColor: "orange",
                    borderWidth: 2
                },
                {
                    label: "Monatsschnitt",
                    data: [mAvg, mAvg, mAvg, mAvg],
                    type: "line",
                    borderColor: "cyan",
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: false,
                    grid: { color: "rgba(255,255,255,0.15)" }
                },
                x: {
                    grid: { color: "rgba(255,255,255,0.08)" }
                }
            }
        }
    });
}

/* ---------------------------------------------------------
   SEITEN GENERIERUNG
--------------------------------------------------------- */

function buildPages() {
    const parsed = parseData(rawText);
    const months = groupByMonth(parsed);

    const container = document.getElementById("content");

    for (const month in months) {
        const monthPage = document.createElement("div");
        monthPage.className = "month-page";

        monthPage.innerHTML += `<h2>Monat: ${month}</h2>
            <div class='legend'>
                <b>Gelb:</b> Tagesschnitt &nbsp;&nbsp;
                <b>Orange:</b> Wochenschnitt &nbsp;&nbsp;
                <b>Cyan:</b> Monatsschnitt
            </div>`;

        const dates = Object.keys(months[month]).sort();

        // Monatsschnitt berechnen
        const allValues = [];
        for (const d of dates) {
            const v = months[month][d];
            const vals = [v.Fr√ºh, v.Mittag, v.Abend, v.Schlaf].filter(x => x);
            allValues.push(...vals);
        }
        const monthAvg = Math.round(allValues.reduce((a,b)=>a+b,0) / allValues.length);

        const weeks = {};

        for (const d of dates) {
            const w = weekOfMonth(d);
            if (!weeks[w]) weeks[w] = [];
            weeks[w].push(d);
        }

        for (const w in weeks) {
            const weekBlock = document.createElement("div");
            weekBlock.className = "week-block";

            weekBlock.innerHTML += `<div class='week-title'>Woche ${w}</div>`;

            const weekDates = weeks[w];

            // Wochenschnitt
            const wvals = [];
            for (const d of weekDates) {
                const v = months[month][d];
                wvals.push(...[v.Fr√ºh, v.Mittag, v.Abend, v.Schlaf].filter(x=>x));
            }
            const weekAvg = Math.round(wvals.reduce((a,b)=>a+b,0) / wvals.length);

            for (const d of weekDates) {
                const dayset = months[month][d];
                const values = [dayset.Fr√ºh, dayset.Mittag, dayset.Abend, dayset.Schlaf].filter(x => x != null);
                const avg = Math.round(values.reduce((a,b)=>a+b,0) / values.length);
                dayset.avg = avg;

                const chartDiv = document.createElement("div");
                chartDiv.className = "chart-container";

                chartDiv.innerHTML = `<h3>${d} (√ò ${avg})</h3>
                    <canvas></canvas>`;

                weekBlock.appendChild(chartDiv);

                const ctx = chartDiv.querySelector("canvas").getContext("2d");
                makeChart(ctx, dayset, weekAvg, monthAvg);
            }

            monthPage.appendChild(weekBlock);
        }

        container.appendChild(monthPage);
    }
}

/* ---------------------------------------------------------
   PDF EXPORT
--------------------------------------------------------- */

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "px", format: "a4" });

    const pages = document.querySelectorAll(".month-page");

    for (let i = 0; i < pages.length; i++) {
        if (i !== 0) pdf.addPage();
        await pdf.html(pages[i], { x: 10, y: 10 });
    }

    // PDF Name = erster + letzter Tag
    const keys = Object.keys(parseData(rawText)).sort();
    const name = `${keys[0]}_bis_${keys[keys.length - 1]}.pdf`;

    pdf.save(name);
}

buildPages();
</script>

</body>
</html>
