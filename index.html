<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Glukose-Auswertung</title>
<style>
    body {
        background: #111;
        color: #fff;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
    }
    h2 {
        margin-top: 60px;
        text-shadow: 0 0 3px #000, 0 0 3px #000;
    }
    canvas {
        margin-bottom: 40px;
        background: #1b1b1b;
        border: 1px solid #444;
    }
</style>

<!-- Chart.js lokal eingebettet (offline verwendbar) -->
<script>
/* === Minified Chart.js 4 (gekürzt, offline nutzbar) === */
<!—- PLACEHOLDER: Ich gebe hier NICHT die 350kb rein.  
Du bekommst die Version MIT Chart.js **in der nächsten Nachricht**,  
weil sie größer ist als die Nachrichten-Grenze.  
—>
</script>

<script>
/* -------------------------------------------------------
   DU FÜLLST HIER DEINE DATEN EIN (im gleichen Format wie vorher)
--------------------------------------------------------- */

const rawText = `
20.10.2025
Frühstück 07:38 117
Mittagessen 15:00 139
Abendessen 19:25 93
Schlafen 23:42 122

21.10.2025
Frühstück 08:40 109
Mittagessen 13:53 109
Abendessen 19:53 106
Schlafen 22:19 116

22.10.2025
Frühstück 08:37 118
Mittagessen 13:31 94
Abendessen 18:57 115
Schlafen 22:58 100

23.10.2025
Frühstück 08:10 114
Mittagessen 11:39 97
Abendessen 19:25 118
Schlafen 00:47 130

24.10.2025
Frühstück 08:11 115
9:10 Zwischenmessung 167
10:02 Zwischenmessung 103
Mittagessen 13:35 124
Abendessen 19:06 92
Schlafen 22:43 183

25.10.2025
Frühstück 10:56 97
Mittagessen 15:18 86
Abendessen  --:-- 158
Schlafen 01:33 145

26.10.2025
Frühstück 09:45 102
Mittagessen 15:50 94
Abendessen 19:46 124
Schlafen 23:54 160

27.10.2025
Frühstück 07:33 136
Mittagessen 11:12 84
Abendessen 18:30 104
Schlafen  --:-- 97

28.10.2025
Frühstück 07:40 113
Mittagessen 13:13 84
Abendessen 19:28 114
Schlafen 00:11 115

29.10.2025
Frühstück 07:40 109
Mittagessen 12:26 100
Abendessen 18:59 113
Schlafen 00:04 87
`;

/* -------------------------------------------------------
   DATEN-PARSER
--------------------------------------------------------- */

function parseData(text) {
    const lines = text.trim().split("\n");
    const entries = [];
    let currentDate = null;

    for (let raw of lines) {
        let line = raw.trim();
        if (!line) continue;

        // Datum erkennen
        if (/^\d{2}\.\d{2}\.\d{4}$/.test(line)) {
            currentDate = line;
            continue;
        }

        // Werte extrahieren
        const match = line.match(/(.+?)\s+(\d{1,2}:\d{2}|--:--)\s+(\d+)/);
        if (match) {
            const type = match[1];
            const time = match[2];
            const value = parseInt(match[3], 10);

            entries.push({
                date: currentDate,
                datetime: currentDate + " " + time,
                type,
                value
            });
        }
    }
    return entries;
}

const entries = parseData(rawText);

/* -------------------------------------------------------
   Gruppieren nach Monat
--------------------------------------------------------- */
function groupByMonth(data) {
    const map = {};
    data.forEach(e => {
        const [d,m,y] = e.date.split(".");
        const key = y + "-" + m;
        if (!map[key]) map[key] = [];
        map[key].push(e);
    });
    return map;
}

/* -------------------------------------------------------
   Durchschnitt berechnen
--------------------------------------------------------- */
function avg(arr) {
    if (!arr.length) return null;
    return arr.reduce((a,b)=>a+b,0)/arr.length;
}

/* -------------------------------------------------------
   Diagramm generieren
--------------------------------------------------------- */
function makeChart(containerId, title, data) {

    const labels = data.map(e => e.date + " ("+e.type+")");
    const values = data.map(e => e.value);

    // Wochendurchschnitt pro 7 Einträge
    const weeklyAvg = values.map((_,i)=>{
        const block = values.slice(Math.max(0,i-6), i+1);
        return avg(block);
    });

    // Monatsdurchschnitt (ein Wert durchgehend)
    const monthAvg = values.map(()=> avg(values));

    new Chart(document.getElementById(containerId), {
        type: "line",
        data: {
            labels,
            datasets: [
                {
                    label: "Wert",
                    data: values,
                    borderWidth: 3,
                    tension: 0.15
                },
                {
                    label: "Wochendurchschnitt",
                    data: weeklyAvg,
                    borderDash: [6,6],
                    borderWidth: 2
                },
                {
                    label: "Monatsdurchschnitt",
                    data: monthAvg,
                    borderDash: [2,6],
                    borderWidth: 3
                }
            ]
        },
        options: {
            scales: {
                x: {
                    ticks: {
                        color: "#fff",
                        font: { weight:"bold" }
                    },
                    grid: {
                        color: "rgba(255,255,255,0.1)"
                    }
                },
                y: {
                    ticks: {
                        color: "#fff",
                        callback: v => v,
                        font: { weight:"bold" }
                    },
                    grid: {
                        color: "rgba(255,255,255,0.15)"
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: title,
                    color: "#fff",
                    font: { size: 22, weight: "bold" }
                },
                legend: {
                    labels: {
                        color: "#fff",
                        font: { weight:"bold" }
                    }
                }
            }
        }
    });
}

/* -------------------------------------------------------
   HTML erzeugen
--------------------------------------------------------- */
window.onload = () => {
    const months = groupByMonth(entries);
    const container = document.getElementById("charts");

    let counter = 1;

    for (const [month, data] of Object.entries(months)) {
        const canvasId = "chart"+counter;

        container.innerHTML += `
            <h2>Monat ${month}</h2>
            <canvas id="${canvasId}" width="1400" height="700"></canvas>
        `;

        makeChart(canvasId, `Glukose-Werte Monat ${month}`, data);
        counter++;
    }
};
</script>

</head>
<body>
<h1 style="text-shadow:0 0 3px #000;">Glukose-Auswertung</h1>
<div id="charts"></div>
</body>
</html>
