<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Glukose Diagramm Generator</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        color: #111;
        padding: 20px;
    }

    h1 {
        text-align: center;
        font-size: 32px;
    }

    textarea {
        width: 100%;
        height: 220px;
        font-size: 14px;
        background: #fff;
        color: #000;
        border: 1px solid #999;
        padding: 10px;
    }

    button {
        padding: 12px;
        margin-top: 10px;
        background: #4CAF50;
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
    }

    button:hover {
        background: #45A049;
    }

    canvas {
        margin-top: 20px;
        width: 100%;
        border: 1px solid #ccc;
        background: #ffffff;
    }

    .page {
        page-break-after: always;
        margin-bottom: 50px;
    }

    .legend {
        padding: 12px;
        background: #fff;
        border: 1px solid #ccc;
        margin-bottom: 15px;
        display: flex;
        gap: 20px;
        font-size: 14px;
    }

    .legend div {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .box {
        width: 16px;
        height: 16px;
    }

</style>
</head>
<body>

<h1>Glukose Diagramm Generator</h1>

<p>Daten einfügen:</p>
<textarea id="input"></textarea>
<button onclick="generate()">Diagramme erzeugen</button>

<div id="output"></div>

<script>
/* ---------------------------------------------------------
   DATEN PARSEN
------------------------------------------------------------*/

function parseData(text) {
    const lines = text.split("\n").map(l => l.trim());
    const entries = [];
    let currentDate = null;

    const typeColors = {
        "Frühstück": "#00aaff",
        "Mittagessen": "#00cc44",
        "Abendessen": "#ff9900",
        "Schlafen": "#ff3333",
        "Zwischenmessung": "#aa55ff"
    };

    for (let line of lines) {
        if (line.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
            currentDate = line;
            continue;
        }

        const m = line.match(/(Frühstück|Mittagessen|Abendessen|Schlafen|Zwischenmessung).*?(\d+)\s*$/);
        if (m && currentDate) {
            entries.push({
                date: currentDate,
                type: m[1],
                value: parseInt(m[2]),
                color: typeColors[m[1]]
            });
        }
    }
    return entries;
}

/* ---------------------------------------------------------
   NACH KALENDERWOCHE GRUPPIEREN
------------------------------------------------------------*/

function dateToISO(d) {
    const [day, month, year] = d.split(".");
    return new Date(`${year}-${month}-${day}`);
}

function getWeekNumber(date) {
    const d = new Date(date.getTime());
    d.setHours(0,0,0,0);
    d.setDate(d.getDate() + 4 - (d.getDay() || 7));
    const yearStart = new Date(d.getFullYear(), 0, 1);
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function groupByWeek(entries) {
    const map = {};

    for (let e of entries) {
        const iso = dateToISO(e.date);
        const year = iso.getFullYear();
        const week = getWeekNumber(iso);
        const key = `${year}-KW${week}`;

        if (!map[key]) map[key] = [];
        map[key].push(e);
    }

    return map;
}

/* ---------------------------------------------------------
   ZEICHNEN
------------------------------------------------------------*/

function avg(arr) {
    return arr.reduce((a,b)=>a+b,0) / arr.length;
}

function drawChart(canvas, weekData, title, startDate, endDate) {
    const ctx = canvas.getContext("2d");
    const W = canvas.width;
    const H = canvas.height;

    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,W,H);

    const uniqueDays = [...new Set(weekData.map(e => e.date))];

    const maxValue = Math.max(...weekData.map(e => e.value), 160);
    const maxBarHeight = H - 140;

    let x = 80;
    const barWidth = 18;
    const barGap = 10;

    // Orientierungslinien
    ctx.strokeStyle = "rgba(0,0,0,0.15)";
    for (let i = 0; i < 6; i++) {
        const y = 60 + i * ((H-140)/5);
        ctx.beginPath();
        ctx.moveTo(60, y);
        ctx.lineTo(W - 40, y);
        ctx.stroke();
    }

    // Titel
    ctx.fillStyle = "#000";
    ctx.font = "24px Arial";
    ctx.fillText(title, 70, 40);

    ctx.font = "14px Arial";

    for (let day of uniqueDays) {
        const dayEntries = weekData.filter(e => e.date === day);

        // Datum unter Balken
        ctx.save();
        ctx.translate(x, H - 50);
        ctx.rotate(-Math.PI/2);
        ctx.fillStyle = "#000";
        ctx.fillText(day, 0, 0);
        ctx.restore();

        for (let e of dayEntries) {
            const h = (e.value / maxValue) * maxBarHeight;

            ctx.fillStyle = e.color;
            ctx.fillRect(x, (H - 80) - h, barWidth, h);

            ctx.fillStyle = "#000";
            ctx.fillText(e.value, x, (H - 85) - h);

            x += barWidth + barGap;
        }
    }
}

/* ---------------------------------------------------------
   GENERIEREN
------------------------------------------------------------*/

function generate() {
    const text = document.getElementById("input").value;
    if (!text.trim()) return;

    const output = document.getElementById("output");
    output.innerHTML = "";

    const entries = parseData(text);
    const weeks = groupByWeek(entries);

    // Legende
    const legend = document.createElement("div");
    legend.className = "legend";
    legend.innerHTML = `
        <div><div class="box" style="background:#00aaff"></div> Frühstück</div>
        <div><div class="box" style="background:#00cc44"></div> Mittag</div>
        <div><div class="box" style="background:#ff9900"></div> Abend</div>
        <div><div class="box" style="background:#ff3333"></div> Schlafen</div>
        <div><div class="box" style="background:#aa55ff"></div> Zwischen</div>
    `;
    output.appendChild(legend);

    for (let week in weeks) {
        const data = weeks[week];

        const sorted = data.slice().sort((a,b)=>dateToISO(a.date)-dateToISO(b.date));
        const start = sorted[0].date;
        const end = sorted[sorted.length-1].date;

        const page = document.createElement("div");
        page.className = "page";

        const header = document.createElement("h2");
        header.textContent = `${week} – ${start} bis ${end}`;
        page.appendChild(header);

        const canvas = document.createElement("canvas");
        canvas.width = 1800;
        canvas.height = 900;

        drawChart(canvas, sorted, week, start, end);
        page.appendChild(canvas);

        output.appendChild(page);
    }
}
</script>
</body>
</html>
