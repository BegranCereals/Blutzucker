<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Glukose Diagramm Generator</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #111;
        color: #eee;
        padding: 20px;
    }

    h1 {
        text-align: center;
        color: white;
        -webkit-text-stroke: 0.6px black;
    }

    textarea {
        width: 100%;
        height: 220px;
        font-size: 14px;
        background: #000;
        color: #fff;
        border: 1px solid #666;
        padding: 10px;
    }

    button {
        padding: 12px;
        margin-top: 10px;
        background: #4CAF50;
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
        width: 100%;
    }

    button:hover {
        background: #45A049;
    }

    canvas {
        margin-top: 30px;
        width: 100%;
        border: 1px solid #444;
        background: #222;
    }

    .page {
        page-break-after: always;
        margin-bottom: 60px;
    }

    .legend-box {
        font-size: 14px;
        margin-bottom: 10px;
        color: #fff;
        -webkit-text-stroke: 0.4px black;
    }

</style>
</head>
<body>

<h1>Glukose Diagramm Generator</h1>

<p>Trage deine Daten hier ein:</p>
<textarea id="input"></textarea>
<button onclick="generate()">Diagramm erzeugen</button>

<div id="output"></div>

<script>
/* ---------------------------------------------------------
   Hilfsfunktionen
------------------------------------------------------------*/

function parseData(text) {
    const lines = text.split("\n").map(l => l.trim());
    const entries = [];
    let currentDate = null;

    for (let line of lines) {
        if (line.match(/^\d{1,2}\.\d{1,2}\.\d{4}$/)) {
            currentDate = line;
            continue;
        }

        const m = line.match(/(Frühstück|Mittagessen|Abendessen|Schlafen|Zwischenmessung).*?(\d+)\s*$/);
        if (m && currentDate) {
            entries.push({
                date: currentDate,
                type: m[1],
                value: parseInt(m[2])
            });
        }
    }
    return entries;
}

/* ---------------------------------------------------------
   Gruppiert Einträge nach Monat → { "2025-10": [..] }
------------------------------------------------------------*/
function groupByMonth(entries) {
    const map = {};
    for (let e of entries) {
        const [d,m,y] = e.date.split(".");
        const key = `${y}-${m}`;
        if (!map[key]) map[key] = [];
        map[key].push(e);
    }
    return map;
}

/* ---------------------------------------------------------
   Durchschnitt berechnen
------------------------------------------------------------*/
function avg(array) {
    if (!array.length) return 0;
    return array.reduce((a,b)=>a+b,0) / array.length;
}

/* ---------------------------------------------------------
   Zeichnet ein Diagramm auf Canvas
------------------------------------------------------------*/
function drawChart(canvas, monthEntries, title) {
    const ctx = canvas.getContext("2d");
    const W = canvas.width;
    const H = canvas.height;

    ctx.fillStyle = "#222";
    ctx.fillRect(0,0,W,H);

    // Orientierungslinien
    ctx.strokeStyle = "rgba(255,255,255,0.15)";
    ctx.lineWidth = 1;
    for (let i = 0; i < 6; i++) {
        let y = 50 + i * ((H-120)/5);
        ctx.beginPath();
        ctx.moveTo(60, y);
        ctx.lineTo(W-30, y);
        ctx.stroke();
    }

    // Zahlen extrahieren (1 Woche = 7 Tage pro Zeile)
    const days = monthEntries.map(e => e.date);
    const uniqueDays = [...new Set(days)];

    const barWidth = 18;
    const barGap = 14;
    const maxBarHeight = H - 160;

    // Monatsschnitt
    const monthAvg = avg(monthEntries.map(e => e.value));

    // Wertebereich
    const maxValue = Math.max(...monthEntries.map(e => e.value), 180);

    // Balken zeichnen
    let x = 70;
    for (let day of uniqueDays) {
        const dayEntries = monthEntries.filter(e => e.date === day);

        // Wochentrenner
        if (new Date(day.split(".").reverse().join("-")).getDay() === 1) {
            ctx.strokeStyle = "rgba(255,255,255,0.25)";
            ctx.beginPath();
            ctx.moveTo(x, 40);
            ctx.lineTo(x, H-60);
            ctx.stroke();
        }

        for (let e of dayEntries) {
            const h = (e.value / maxValue) * maxBarHeight;
            ctx.fillStyle = "rgba(0,150,255,0.85)";
            ctx.fillRect(x, (H-80)-h, barWidth, h);

            // Wert über Balken
            ctx.fillStyle = "#fff";
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 3;
            ctx.strokeText(String(e.value), x, (H-85)-h);
            ctx.fillText(String(e.value), x, (H-85)-h);

            x += barWidth + barGap;
        }

        // Datum unter Balken
        ctx.save();
        ctx.translate(x - (barGap+barWidth), H-45);
        ctx.rotate(-Math.PI/2);
        ctx.fillStyle = "#fff";
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.strokeText(day, 0, 0);
        ctx.fillText(day, 0, 0);
        ctx.restore();
    }

    // Monatsschnitt Linie
    ctx.strokeStyle = "rgba(255, 200, 0, 0.9)";
    ctx.lineWidth = 2;
    let yAvg = (H-80) - (monthAvg/maxValue)*maxBarHeight;
    ctx.beginPath();
    ctx.moveTo(60, yAvg);
    ctx.lineTo(W-30, yAvg);
    ctx.stroke();

    // Monatsschnitt Text
    ctx.fillStyle = "#fff";
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.strokeText(`Monatsschnitt: ${monthAvg.toFixed(1)}`, 65, yAvg - 5);
    ctx.fillText(`Monatsschnitt: ${monthAvg.toFixed(1)}`, 65, yAvg - 5);

    // Titel
    ctx.fillStyle = "#fff";
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 3;
    ctx.strokeText(title, 80, 30);
    ctx.fillText(title, 80, 30);
}

/* ---------------------------------------------------------
   Generiere Seiten
------------------------------------------------------------*/
function generate() {
    const text = document.getElementById("input").value;
    const entries = parseData(text);
    const months = groupByMonth(entries);

    const out = document.getElementById("output");
    out.innerHTML = "";

    for (let month in months) {
        let page = document.createElement("div");
        page.className = "page";

        let title = document.createElement("div");
        title.className = "legend-box";
        title.innerHTML = `<b>Monat: ${month}</b>`;
        page.appendChild(title);

        let canvas = document.createElement("canvas");
        canvas.width = 1800;
        canvas.height = 900;
        page.appendChild(canvas);

        drawChart(canvas, months[month], `Glukosewerte – ${month}`);

        out.appendChild(page);
    }
}
</script>

</body>
</html>
